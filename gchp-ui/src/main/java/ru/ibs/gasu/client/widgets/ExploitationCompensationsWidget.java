package ru.ibs.gasu.client.widgets;

import com.google.gwt.core.client.GWT;
import com.google.gwt.core.client.Scheduler;
import com.google.gwt.event.logical.shared.SelectionEvent;
import com.google.gwt.event.logical.shared.SelectionHandler;
import com.google.gwt.i18n.client.DateTimeFormat;
import com.google.gwt.user.client.ui.IsWidget;
import com.google.gwt.user.client.ui.Widget;
import com.sencha.gxt.cell.core.client.form.ComboBoxCell;
import com.sencha.gxt.core.client.ValueProvider;
import com.sencha.gxt.core.client.util.Margins;
import com.sencha.gxt.data.shared.ModelKeyProvider;
import com.sencha.gxt.data.shared.TreeStore;
import com.sencha.gxt.widget.core.client.box.MessageBox;
import com.sencha.gxt.widget.core.client.button.TextButton;
import com.sencha.gxt.widget.core.client.container.BoxLayoutContainer;
import com.sencha.gxt.widget.core.client.container.HBoxLayoutContainer;
import com.sencha.gxt.widget.core.client.container.VerticalLayoutContainer;
import com.sencha.gxt.widget.core.client.event.SelectEvent;
import com.sencha.gxt.widget.core.client.form.*;
import com.sencha.gxt.widget.core.client.grid.ColumnConfig;
import com.sencha.gxt.widget.core.client.grid.ColumnModel;
import com.sencha.gxt.widget.core.client.grid.editing.ClicksToEdit;
import com.sencha.gxt.widget.core.client.grid.editing.GridInlineEditing;
import com.sencha.gxt.widget.core.client.toolbar.SeparatorToolItem;
import com.sencha.gxt.widget.core.client.treegrid.TreeGrid;
import ru.ibs.gasu.client.widgets.componens.DateFieldFullDate;
import ru.ibs.gasu.client.widgets.componens.ToolbarButton;
import ru.ibs.gasu.common.models.PlanFactIndicator;
import ru.ibs.gasu.common.models.PlanFactYear;
import ru.ibs.gasu.common.models.SimpleIdNameModel;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.List;

import static ru.ibs.gasu.client.widgets.WidgetUtils.*;

public class ExploitationCompensationsWidget implements IsWidget {

    private VerticalLayoutContainer container;
    private TreeGrid<PlanFactYear> treeGrid;
    private TextButton addYearButton;
    private TextButton removeYearButton;
    private StringComboBox yearBox;
    private TreeStore<PlanFactYear> treeStore;
    private HBoxLayoutContainer buttonsContainer;
    private CheckBox ndsCheck;
    private ComboBox<SimpleIdNameModel> measureType;
    private DateField dateField;
    private List<Integer> currentYears = new ArrayList<>();
    private TextButton expandButton;
    private TextButton collapseButton;

    public VerticalLayoutContainer getContainer() {
        return container;
    }

    public TreeGrid<PlanFactYear> getTreeGrid() {
        return treeGrid;
    }

    public TextButton getAddYearButton() {
        return addYearButton;
    }

    public TextButton getRemoveYearButton() {
        return removeYearButton;
    }

    public StringComboBox getYearBox() {
        return yearBox;
    }

    public HBoxLayoutContainer getButtonsContainer() {
        return buttonsContainer;
    }

    public CheckBox getNdsCheck() {
        return ndsCheck;
    }

    public void setNdsCheck(CheckBox ndsCheck) {
        this.ndsCheck = ndsCheck;
    }

    public ComboBox<SimpleIdNameModel> getMeasureType() {
        return measureType;
    }

    public void setMeasureType(ComboBox<SimpleIdNameModel> measureType) {
        this.measureType = measureType;
    }

    public DateField getDateField() {
        return dateField;
    }

    public void setDateField(DateField dateField) {
        this.dateField = dateField;
    }

    public List<Integer> getCurrentYears() {
        return currentYears;
    }

    public TextButton getExpandButton() {
        return expandButton;
    }

    public TextButton getCollapseButton() {
        return collapseButton;
    }


    public ExploitationCompensationsWidget() {
        initButtonContainer();
        initGrid();
        setUpBaseIndicators();
        fillMeasureTypeCombo();

        measureType.addSelectionHandler(new SelectionHandler<SimpleIdNameModel>() {
            @Override
            public void onSelection(SelectionEvent<SimpleIdNameModel> event) {
                if ("2".equals(event.getSelectedItem().getId())) {
                    dateField.show();
                } else if ("1".equals(event.getSelectedItem().getId())) {
                    dateField.clear();
                    dateField.hide();
                }

                Scheduler.get().scheduleDeferred(() -> buttonsContainer.forceLayout());

            }
        });

        measureType.setValue(new SimpleIdNameModel("2", "На дату"));
        container.add(buttonsContainer, STD_VC_LAYOUT);
        container.add(treeGrid, STD_VC_LAYOUT);
    }

    private void fillMeasureTypeCombo() {
        measureType.getStore().add(new SimpleIdNameModel("1", "В ценах соответствующих лет"));
        measureType.getStore().add(new SimpleIdNameModel("2", "На дату"));
    }

    private void initButtonContainer() {
        container = new VerticalLayoutContainer();
        yearBox = new StringComboBox(generateComboBoxYears());
        yearBox.setValue(getCurrentYear());
        yearBox.setEditable(false);
        yearBox.setTriggerAction(ComboBoxCell.TriggerAction.ALL);
        ndsCheck = new CheckBox();
        ndsCheck.setBoxLabel("Включая НДС");
        measureType = WidgetUtils.createCommonFilterModelComboBox("Выберите тип измерения");
        dateField = new DateFieldFullDate();
        FieldLabel measureTypeLabel = createFieldLabelLeft(measureType, "Тип измерения");

        addYearButton = new ToolbarButton("Добавить год", "fas fa-calendar-plus-o");
        removeYearButton = new ToolbarButton("Удалить год", "fas fa-calendar-minus-o");
        expandButton = new ToolbarButton("Развернуть", "fas fa-expand");
        collapseButton = new ToolbarButton("Свернуть", "fa-compress");

        buttonsContainer = new HBoxLayoutContainer();
        BoxLayoutContainer.BoxLayoutData boxLayoutData = new BoxLayoutContainer.BoxLayoutData(new Margins(0, 5, 0, 0));
        buttonsContainer.add(collapseButton, boxLayoutData);
        buttonsContainer.add(expandButton, boxLayoutData);
        SeparatorToolItem separator = new SeparatorToolItem();
        separator.setHeight(ToolbarButton.DEFAULT_HEIGHT);
        buttonsContainer.add(separator, boxLayoutData);
        buttonsContainer.add(addYearButton, boxLayoutData);
        buttonsContainer.add(removeYearButton, boxLayoutData);
        separator = new SeparatorToolItem();
        separator.setHeight(ToolbarButton.DEFAULT_HEIGHT);
        buttonsContainer.add(separator, boxLayoutData);

        buttonsContainer.add(ndsCheck, boxLayoutData);
        buttonsContainer.add(yearBox, boxLayoutData);
        buttonsContainer.add(measureType, boxLayoutData);
        buttonsContainer.add(dateField, boxLayoutData);

        addYearButton.addSelectHandler(new SelectEvent.SelectHandler() {
            @Override
            public void onSelect(SelectEvent event) {
                Integer selectedYear = Integer.valueOf(yearBox.getValue());
                if (currentYears.contains(selectedYear)) {
                    new MessageBox("Ошибка", "Данный год уже есть в возмещениях").show();
                    return;
                }
                for (PlanFactYear rootItem : treeStore.getRootItems()) {
                    PlanFactYear t = new PlanFactYear();
                    t.setGid(getRandId());
                    t.setNameOrYear(String.valueOf(selectedYear));
                    treeStore.add(rootItem, t);
                }
                currentYears.add(selectedYear);
            }
        });

        removeYearButton.addSelectHandler(new SelectEvent.SelectHandler() {
            @Override
            public void onSelect(SelectEvent event) {
                Integer selectedYear = Integer.valueOf(yearBox.getValue());
                for (PlanFactYear rootItem : treeStore.getRootItems()) {
                    for (PlanFactYear child : treeStore.getChildren(rootItem)) {
                        if (child.getNameOrYear().equals(yearBox.getValue())) {
                            treeStore.remove(child);
                        }
                    }
                }
                currentYears.remove(selectedYear);
            }
        });
        expandButton.addSelectHandler(new SelectEvent.SelectHandler() {
            @Override
            public void onSelect(SelectEvent event) {
                treeGrid.expandAll();
            }
        });
        collapseButton.addSelectHandler(new SelectEvent.SelectHandler() {
            @Override
            public void onSelect(SelectEvent event) {
                treeGrid.collapseAll();
            }
        });
    }

    private void initGrid() {
        treeStore = new TreeStore<>(new ModelKeyProvider<PlanFactYear>() {
            @Override
            public String getKey(PlanFactYear item) {
                String key = (item instanceof PlanFactIndicator ? "p-" : "by-") + item.getGid();
                return key;
            }
        });
        treeStore.setAutoCommit(true);

        ColumnConfig<PlanFactYear, String> nameOrYear = new ColumnConfig<>(new ValueProvider<PlanFactYear, String>() {
            @Override
            public String getValue(PlanFactYear object) {
                return object.getNameOrYear();
            }

            @Override
            public void setValue(PlanFactYear object, String value) {
                object.setNameOrYear(value);
            }

            @Override
            public String getPath() {
                return "nameOrYear";
            }
        }, 10, "Возмещение/Год");
        ColumnConfig<PlanFactYear, String> plan = new ColumnConfig<>(new ValueProvider<PlanFactYear, String>() {
            @Override
            public String getValue(PlanFactYear object) {
                return WidgetUtils.doubleToString(object.getPlan());
            }

            @Override
            public void setValue(PlanFactYear object, String value) {
                if (value == null) {
                    object.setPlan(null);
                    return;
                }
                try {
                    object.setPlan(Double.parseDouble(value));
                } catch (Exception ex) {
                }
            }

            @Override
            public String getPath() {
                return "plan";
            }
        }, 10, "План");
        ColumnConfig<PlanFactYear, String> fact = new ColumnConfig<>(new ValueProvider<PlanFactYear, String>() {
            @Override
            public String getValue(PlanFactYear object) {
                return WidgetUtils.doubleToString(object.getFact());
            }

            @Override
            public void setValue(PlanFactYear object, String value) {
                GWT.log("fact set");
                if (value == null) {
                    object.setFact(null);
                    return;
                }
                ;
                object.setFact(Double.parseDouble(value));
            }

            @Override
            public String getPath() {
                return "fact";
            }
        }, 10, "Факт");

        ColumnModel<PlanFactYear> cm = new ColumnModel<>(Arrays.asList(nameOrYear, plan, fact));
        treeGrid = new TreeGrid<>(treeStore, cm, nameOrYear);
        treeGrid.setExpandOnDoubleClick(false);
        treeGrid.getView().setForceFit(true);
        treeGrid.getView().setEmptyText(GRID_EMPTY_TEXT_VAR1);
        treeGrid.getView().setStripeRows(true);

        final GridInlineEditing<PlanFactYear> editing = new GridInlineEditing<PlanFactYear>(treeGrid);
        editing.setClicksToEdit(ClicksToEdit.ONE);
        editing.addEditor(plan, WidgetUtils.createEditField());
        editing.addEditor(fact, WidgetUtils.createEditField());
    }

    protected void setUpBaseIndicators() {
        currentYears.clear();

        PlanFactIndicator planFactIndicator1 = new PlanFactIndicator();
        planFactIndicator1.setGid(1L);
        planFactIndicator1.setNameOrYear("Всего");

        treeStore.add(planFactIndicator1);
    }

    public TreeStore<PlanFactYear> getTreeStore() {
        return treeStore;
    }

    private String getCurrentYear() {
        return DateTimeFormat.getFormat("d-M-yyyy").format(new Date()).split("-")[2];
    }

    private List<String> generateComboBoxYears() {
        Integer currentYear = Integer.parseInt(getCurrentYear());
        List<String> res = new ArrayList<>();
        for (int i = currentYear - 10; i <= currentYear + 20; i++) {
            res.add(String.valueOf(i));
        }
        return res;
    }

    @Override
    public Widget asWidget() {
        return container;
    }
}
